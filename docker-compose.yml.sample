version: "3.8"

services:
  # Web interface for database inspection
  momly_adminer:
    image: adminer
    ports:
      - "8888:8080"
    networks:
      - bridge-network

  # PostgreSQL database server
  momly_psql:
    image: postgres
    environment:
      POSTGRES_PASSWORD: postgres
      POSTGRES_USER: postgres
    volumes:
      - psql:/var/lib/postgresql
    networks:
      - bridge-network

  # Redis cache / job queue backend
  momly_redis:
    image: redis:7.0.11
    command: redis-server
    networks:
      - bridge-network

  # Main Rails application
  momly_backend:
    tty: true
    stdin_open: true
    build:
      context: .
      dockerfile: ./.dockerdev/Dockerfile.dev
    working_dir: /app
    volumes:
      - .:/app
      - bundle_cache:/bundle
    environment:
      # Rails
      RAILS_ENV: development
      PORT: 3000
      BUNDLE_PATH: /bundle

      # Database
      DATABASE_POOL: 5
      DATABASE_HOST: momly_psql
      DATABASE_PORT: 5432
      DATABASE_USER: postgres
      DATABASE_PASSWORD: postgres

      # Redis
      REDIS_URL: redis://momly_redis:6379

      # Google Web App
      GOOGLE_APP_ID: ""
      GOOGLE_APP_SECRET: ""

      # Security & captcha
      RECAPTCHA_SITE_KEY: ""
      RECAPTCHA_SECRET_KEY: ""
      GOOGLE_SAFE_BROWSING_API_KEY: ""
    command: /bin/sh ".dockerdev/commander/rails.sh"
    ports:
      - "3001:3000"
    depends_on:
      - momly_psql
      - momly_redis
      - momly_sidekiq
    networks:
      - bridge-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Background job processor
  momly_sidekiq:
    tty: true
    stdin_open: true
    build:
      context: .
      dockerfile: ./.dockerdev/Dockerfile.dev
    working_dir: /app
    volumes:
      - .:/app
      - bundle_cache:/bundle
    environment:
      RAILS_ENV: development
      BUNDLE_PATH: /bundle
      DATABASE_HOST: momly_psql
      DATABASE_PORT: 5432
      DATABASE_USER: postgres
      DATABASE_PASSWORD: postgres
      REDIS_URL: redis://momly_redis:6379
    command: /bin/sh ".dockerdev/commander/sidekiq.sh"
    depends_on:
      - momly_psql
      - momly_redis
    networks:
      - bridge-network

networks:
  bridge-network:

volumes:
  psql:
  bundle_cache:
